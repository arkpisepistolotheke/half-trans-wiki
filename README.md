# half-trans-wiki

A small userscript that turns short-code links on the akp.fandom.com/zh wiki into direct external links, loading the destination mapping from a wiki-hosted JSON page.

Features
- Loads a JSON mapping from a wiki raw page (default: Help:HTW/map.json).
- Converts links that point to the HTW help page and include a shortcode in the fragment (e.g. Help:HTW#code:target/path) into direct external links.
- Opens resolved links in a new tab and marks them as external.
- Observes DOM mutations so dynamically-inserted links are processed.

Installation
1. Install a userscript manager (Tampermonkey, Greasemonkey).
2. Create a new userscript and paste the contents of index.js, or save the repo's index.js as a raw userscript and install it.
3. Ensure the script is enabled while browsing https://akp.fandom.com/zh/*.

Default behavior and configuration
- The script looks for a JSON map at the wiki page specified by WIKI_CONFIG_PAGE in the script. Default:
  - Help:HTW/map.json (the script fetches /zh/index.php?title=Help%3AHTW%2Fmap.json&action=raw)
- The mapping is expected to be a JSON object whose keys are short codes and values are arrays with this shape:
  [protocol, part1, part2, part3, pathTemplate]
  - protocol: "http" or "https"
  - part1/part2/part3: domain parts which will be joined by '.' (empty parts are ignored)
  - pathTemplate: a string where $1 is replaced with the target path (URL-encoded, but the script restores encoded slashes back to '/')

Example map (map.json)
```json
{
  "akp": ["https", "akp", "fandom", "com", "/wiki/$1"],
  "gh":  ["https", "github", "com", "", "/$1"]
}
```

How links should be written
- The userscript looks for anchors whose href contains "/zh/wiki/Help:HTW" and that include a fragment in the form:
  code:target/path
- Example HTML links that will be converted:
  - <a href="/zh/wiki/Help:HTW#akp:Some_Page">AKP page</a>
  - <a href="/zh/wiki/Help:HTW#gh:arkpisepistolotheke/half-trans-wiki">GitHub repo</a>
- parse rules:
  - Shortcode format is: ^([A-Za-z0-9_-]+)\s*:\s*(.+)$
  - The part after the colon becomes $1 in the pathTemplate (URL-encoded; %2F -> / for slashes)

What the script does to links
- Replaces the href with the resolved external URL (constructed from the mapping).
- Adds target="_blank" and rel="nofollow noreferrer noopener".
- Sets className to "external text transwiki-source-link".
- Skips links if no shortcode or no mapping exists for the shortcode.

Runtime behavior and diagnostics
- The script fetches the JSON map using a same-origin fetch to /zh/index.php?title=<page>&action=raw.
- Console messages:
  - "HalfTransWiki：已从 wiki 加载 JSON 映射表" — mapping successfully loaded.
  - "HalfTransWiki：未加载到远端映射表，当前映射表为空" — mapping not loaded (script will still run but no conversions).
  - Warnings if the fetch fails or the raw page is not valid JSON.
- A MutationObserver watches document.body for added nodes and re-processes links so that dynamically inserted content is handled.

Customization
- Change WIKI_CONFIG_PAGE constant in index.js to point to a different wiki page if you host mapping elsewhere.
- Modify the mapping JSON to add or change shortcodes and their target domain/path templates.

Troubleshooting
- If links are not converted:
  - Check browser console for the script's log/warning messages.
  - Verify the raw JSON is reachable at /zh/index.php?title=<page>&action=raw and is valid JSON.
  - Make sure link fragments match the shortcode format (code:target).
- If URLs look malformed, double-check the mapping array elements and the pathTemplate (use $1 for the captured target).

Contributing
- Open issues or PRs on the repository for fixes, improvements, or mapping-format suggestions.
- Keep the mapping loader flexible and fail-safe: the script currently replaces the entire map with the remote object if it parses successfully.

License
- MIT License — see LICENSE.

Author
- Repository: arkpisepistolotheke
- Userscript header author field: ChatGPT

(README generated by GitHub Copilot Chat Assistant.)
